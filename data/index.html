<!DOCTYPE html><html><head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <style>
        html,body {height:100%;margin:0;background-color:#f9f9f9;}
        .box {display:flex;flex-flow:column;padding:10pt;margin:10pt;}
        .sec {display:flex;width:100%;font-family:Arial, Helvetica, sans-serif;font-size:30pt;padding:7pt;align-items:center;gap:7pt;color:#444;}
        .ttl {display:flex;user-select:none;width:32pt;height:32pt;font-size:12pt;border:2px solid #444;border-radius:7px;justify-content:center;align-items:center;box-shadow:2px 2px 2px 2px #AAA;}
        .slider {width:100%;background:#ddd;accent-color:#888;}
    </style>
    <script>
    </script>
</head>
<body>
    <div class="box">
        <div class="sec">
            <div class="ttl" id="btnPwm">PWM</div><span id="valuePwm">255</span>
        </div>
        <input type="range" min="0" max="8192" value="8192" class="slider" id="sliderPwm">
        <div class="sec">
            <div class="ttl">V</div><span id="valueV">0.00</span> V
        </div>
        <div class="sec">
            <div class="ttl">A</div><span id="valueA">0.00</span> A
        </div>
    </div>
    <script>
        class EspRepo {
            constructor() {}
            sendPwmValue(channel,duty) {
                const xhr = new XMLHttpRequest();
                xhr.open('GET','./pwmset?channel='+channel+'&duty=' + duty,true);
                xhr.send();
            }
        }
        class VM {
            constructor(espRepo) {
                this.pwmEnabled = false;
                this.pwmValue = 255;
                this.espRepo = espRepo;
            }

            onPwmClick() {
                this.pwmEnabled = !this.pwmEnabled;
                const xhr = new XMLHttpRequest();
                if (this.pwmEnabled)
                    xhr.open('GET','./pwmon?channel=0&freq=5000&res=8&pin=22&duty=' + this.pwmValue,true);
                else 
                    xhr.open('GET','./pwmoff?channel=0',true);

                xhr.onreadystatechange = function () {
                    if (xhr.readyState===4) {
                        if (xhr.status>=200 && xhr.status<300) {
                            //resolve(xhr.responseText);
                        } else {
                            reject(new Error(`Request failed with status ${xhr.status}`));
                        }
                    }
                };
                xhr.onerror = () => reject(new Error('Network error'));
                xhr.send();
            }

            onSlider(value) {
                const newValue = Math.floor(value / 32);
                if (newValue == this.pwmValue) return;
                this.pwmValue = newValue;
                if (this.pwmEnabled) espRepo.sendPwmValue(0, this.pwmValue);
            }

        }

        const espRepo = new EspRepo();
        const vm = new VM(espRepo);
        const slider = document.getElementById("sliderPwm");
        const output = document.getElementById("valuePwm");
        slider.addEventListener("input", (event) => { vm.onSlider(event.target.value); output.textContent = vm.pwmValue;});
        document.getElementById("btnPwm").addEventListener('click', (event) => { vm.onPwmClick(); });
    </script>
</body></html>